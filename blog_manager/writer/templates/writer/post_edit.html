{% extends "base.html" %}
{% block content %}
<nav class="navbar navbar-expand-lg bg-white border-bottom mb-4">
  <div class="container">
    <a class="navbar-brand" href="#">Writer</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'writer:post_list' %}">Lista post</a>
      <form method="post" action="{% url 'writer:logout' %}" class="d-inline">
        {% csrf_token %}
        <button class="btn btn-outline-secondary btn-sm" type="submit">Logout</button>
      </form>
    </div>
  </div>
</nav>
<div id="result"></div>
<div id="post-meta" data-post-id="{{ post_id }}" style="display:none"></div>
<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h4 mb-4">Modifica post</h1>
    <form id="post-edit-form" class="needs-validation" novalidate>
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-md-8">
          <label class="form-label">Title</label>
          <input name="title" id="title" class="form-control" required>
          <div class="invalid-feedback">Titolo obbligatorio.</div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Slug</label>
          <input name="slug" id="slug" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Site</label>
          <select name="site" id="siteSelect" class="form-select" required></select>
          <div class="invalid-feedback">Seleziona un sito.</div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Author</label>
          <select name="author" id="authorSelect" class="form-select" required></select>
          <div class="invalid-feedback">Seleziona un autore.</div>
        </div>
        <div class="col-md-12">
                  <label class="form-label">Body</label>
          <div class="editor-fixed">
            <textarea name="body" id="body" class="form-control" rows="10" required></textarea>
          </div>
        </div>
                <div class="col-md-12">
                  <label class="form-label">Categories (read-only)</label>
                  <div id="categoriesReadout" class="form-control-plaintext text-muted">&mdash;</div>
                  <div class="form-text">Categories are derived from front-matter and cannot be edited here.</div>
                </div>
  <!-- SEO/meta fields removed: body and core fields only -->
      </div>
      <div class="mt-4">
  <button type="submit" class="btn btn-primary">Salva modifiche</button>
  <button type="button" id="republishBtn" class="btn btn-secondary ms-2">Re-publish</button>
  <button type="button" id="draftBtn" class="btn btn-outline-secondary ms-2">Set as Draft</button>
      </div>
    </form>
  </div>
</div>

<!-- Quick Preview (Unified System) -->
<div class="card shadow-sm mt-4" id="quick-preview-controls">
  <div class="card-header bg-light">
    <h5 class="mb-0">
      <i class="bi bi-eye"></i> Quick Preview
      <span class="badge bg-info ms-2">Nuovo</span>
    </h5>
  </div>
  <div class="card-body">
    <p class="text-muted mb-3">
      Crea una preview veloce del post singolo su <code>blogmanager-previews</code>.
      Ideale per verifiche rapide senza PR.
    </p>
    
    <div id="quick-preview-status" class="mb-3">
      <span class="text-muted small">Nessuna preview attiva</span>
    </div>
    
    <div id="quick-preview-url-area" class="d-none mb-3">
      <div class="input-group">
        <input type="text" class="form-control form-control-sm" id="quick-preview-url-input" readonly>
        <button class="btn btn-outline-secondary btn-sm" type="button" id="copy-preview-url-btn">
          <i class="bi bi-clipboard"></i>
        </button>
        <a href="#" target="_blank" class="btn btn-primary btn-sm" id="visit-preview-btn">
          <i class="bi bi-box-arrow-up-right"></i> Apri
        </a>
      </div>
    </div>
    
    <div class="d-flex gap-2">
      <button type="button" id="create-quick-preview-btn" class="btn btn-success btn-sm">
        <i class="bi bi-play-circle"></i> Crea Preview
      </button>
      <button type="button" id="delete-quick-preview-btn" class="btn btn-outline-danger btn-sm d-none">
        <i class="bi bi-trash"></i> Elimina Preview
      </button>
    </div>
    
    <div id="quick-preview-error" class="alert alert-danger mt-3 d-none"></div>
    
    <div class="mt-3">
      <small class="text-muted">
        <i class="bi bi-info-circle"></i>
        Percorso: <code>public/<span id="site-slug-display">...</span>/post/<span id="post-id-display">${postId}</span>/</code>
      </small>
    </div>
  </div>
</div>

<!-- Preview PR Controls -->
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  /* Responsive editor: full-width on small screens, constrained on large screens */
  .editor-fixed { width: 100%; max-width: 1000px; margin: 0 auto; }
  .editor-fixed textarea, .editor-fixed .EasyMDEContainer, .editor-fixed .CodeMirror, .editor-fixed .editor-toolbar {
    width: 100% !important; max-width: 100% !important; box-sizing: border-box;
  }
  .editor-fixed .CodeMirror { height: 500px !important; max-height: 500px !important; }
  .editor-fixed .CodeMirror-scroll { overflow: auto !important; }
  textarea#body { resize: vertical; }
  
  /* Quick Preview controls styling */
  #quick-preview-controls {
    max-width: 1000px;
    margin: 1.5rem auto;
  }
  
  #quick-preview-url-input {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
  }

  /* Buttons and layout tweaks for small screens */
  @media (max-width: 576px) {
    .editor-fixed { padding: 0 12px; }
    /* Stack action buttons and make them full-width for easier tapping */
    .mt-4 { display: flex; flex-direction: column; gap: 0.5rem; }
    .mt-4 .btn { width: 100%; }
    /* Make the preview card full-width */
    #previewAreaEdit { margin-left: 0 !important; margin-right: 0 !important; }
    #preview-controls { margin-left: 0.5rem; margin-right: 0.5rem; }
  }
</style>
</style>
<script>
// Minimal WriterAPI fallback in case the global helper didn't load
if (typeof WriterAPI === 'undefined') {
  window.WriterAPI = {
    API: {
      POSTS: '/api/blog/posts/',
      SITES: '/api/sites/',
      AUTHORS: '/api/blog/authors/',
    },
    async apiFetch(url, opts={}){
      const defaultHeaders = {};
      if (opts && opts.body && !(opts.headers && opts.headers['Content-Type'])) {
        defaultHeaders['Content-Type'] = 'application/json';
      }
      const method = (opts && opts.method) ? opts.method.toUpperCase() : 'GET';
      if (!['GET','HEAD','OPTIONS'].includes(method)) {
        const csr = (function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`);if(v.length===2)return v.pop().split(';').shift();})('csrftoken');
        if (csr) defaultHeaders['X-CSRFToken'] = csr;
      }
      const headers = Object.assign({}, defaultHeaders, opts.headers || {});
      return fetch(url, Object.assign({}, opts, { headers }));
    }
  };
}
</script>
<script>
// Set as Draft logic
document.getElementById('draftBtn').addEventListener('click', async function() {
  const resBox = document.getElementById('result');
  resBox.innerHTML = '';
  try {
    const res = await WriterAPI.apiFetch(`${WriterAPI.API.POSTS}${postId}/`, {
      method: 'PATCH',
      body: JSON.stringify({ status: 'draft', is_published: false })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(JSON.stringify(data));
    resBox.innerHTML = `<div class="alert alert-success">Post riportato a draft!</div>`;
    loadPost();
  } catch(e) {
    resBox.innerHTML = `<div class="alert alert-danger">Errore: ${e}</div>`;
  }
});
// Robust postId extraction: find a numeric segment in the path (e.g. /writer/posts/123/edit/)
function extractPostId() {
  const meta = document.getElementById('post-meta');
  if (meta && meta.dataset && meta.dataset.postId) return meta.dataset.postId;
  const parts = window.location.pathname.split('/').filter(Boolean);
  for (let i = parts.length - 1; i >= 0; i--) {
    const p = parts[i];
    if (/^\d+$/.test(p)) return p;
  }
  return parts.pop();
}
const postId = extractPostId();
let easyMDE;
async function loadPost() {
  const resultBox = document.getElementById('result');
  try {
    const res = await WriterAPI.apiFetch(`${WriterAPI.API.POSTS}${postId}/`);
    let data = null;
    try { data = await res.json(); } catch (e) { data = null; }
    console.debug('loadPost response', res.status, data);
    if (!res.ok) {
      resultBox.innerHTML = `<div class="alert alert-danger">Errore caricamento post: ${res.status}</div>`;
      return;
    }

    document.getElementById('title').value = data.title || '';
    document.getElementById('slug').value = data.slug || '';

    // set selects (if option missing, insert fallback option)
    const siteSel = document.getElementById('siteSelect');
    if (siteSel && data.site !== undefined && data.site !== null) {
      const v = String(data.site);
      if (!siteSel.querySelector(`option[value="${v}"]`)) {
        siteSel.insertAdjacentHTML('beforeend', `<option value="${v}">Site ${v}</option>`);
      }
      siteSel.value = v;
    }
    const authorSel = document.getElementById('authorSelect');
    if (authorSel && data.author !== undefined && data.author !== null) {
      const v = String(data.author);
      if (!authorSel.querySelector(`option[value="${v}"]`)) {
        authorSel.insertAdjacentHTML('beforeend', `<option value="${v}">Author ${v}</option>`);
      }
      authorSel.value = v;
    }

    // populate read-only categories display (if the API provides names or nested objects)
    try {
      const readout = document.getElementById('categoriesReadout');
      if (readout) {
        if (Array.isArray(data.categories) && data.categories.length) {
          // API may return either list of ids or nested objects; prefer readable names
          const names = data.categories.map(c => (typeof c === 'object' ? (c.name || c.title || c.slug) : String(c))).filter(Boolean);
          readout.textContent = names.length ? names.join(', ') : (data.category_names || '—');
        } else if (data.category_names) {
          readout.textContent = Array.isArray(data.category_names) ? data.category_names.join(', ') : String(data.category_names);
        } else {
          readout.textContent = '—';
        }
      }
    } catch (e) {
      console.warn('Failed to populate categories readout', e);
    }

    // status
    const statusEl = document.querySelector('[name="status"]');
    if (statusEl && data.status) statusEl.value = data.status;

    // published_at -> datetime-local (simple truncate)
    if (data.published_at) {
      const dt = data.published_at.slice(0,16);
      const pub = document.querySelector('[name="published_at"]');
      if (pub) pub.value = dt;
    }

    // cover image
    const cover = document.querySelector('[name="cover_image_url"]'); if (cover && data.cover_image_url) cover.value = data.cover_image_url || '';

    // body/content
    const bodyText = data.content || data.body || '';
    const textarea = document.getElementById('body');
    if (textarea) textarea.value = bodyText;
    easyMDE = new EasyMDE({ element: textarea, spellChecker: false, status: false, autosave: { enabled: false } });
  } catch (err) {
    console.error('loadPost error', err);
    resultBox.innerHTML = `<div class="alert alert-danger">Errore di rete durante il caricamento del post.</div>`;
  }
}
// Autosave & Preview helpers (will be invoked after load)
const POST_ID = postId;
const AUTOSAVE_KEY_EDIT = `writer:draft:edit:${POST_ID}`;
function saveDraftEdit(){
  try{
    const payload = {
      title: document.getElementById('title').value,
      slug: document.getElementById('slug').value,
      site: document.getElementById('siteSelect').value,
      author: document.getElementById('authorSelect').value,
      body: easyMDE ? easyMDE.value() : document.getElementById('body').value,
      ts: new Date().toISOString()
    };
    localStorage.setItem(AUTOSAVE_KEY_EDIT, JSON.stringify(payload));
    const s = document.getElementById('autosaveEditStatus'); if(s) s.textContent = 'Autosaved at ' + new Date().toLocaleTimeString();
  }catch(e){ console.warn('Autosave edit failed', e); }
}
function loadDraftEdit(){
  const raw = localStorage.getItem(AUTOSAVE_KEY_EDIT); if(!raw) return;
  try{ const d = JSON.parse(raw); if(confirm('Ripristinare bozza locale?')){ document.getElementById('title').value=d.title||''; document.getElementById('slug').value=d.slug||''; if(easyMDE) easyMDE.value(d.body||''); else document.getElementById('body').value = d.body||''; }}catch(e){ console.warn('parse draft edit', e); }
}
function setupEditUI(){
  setInterval(saveDraftEdit, 10000);
  loadDraftEdit();
  // Preview button
  const previewBtn = document.createElement('button'); previewBtn.type='button'; previewBtn.className='btn btn-outline-secondary ms-2'; previewBtn.textContent='Preview';
  const submitArea = document.querySelector('#post-edit-form .mt-4');
  if(submitArea){ submitArea.insertBefore(previewBtn, submitArea.children[1] || null); }
  const previewArea = document.createElement('div'); previewArea.id='previewAreaEdit'; previewArea.className='mt-3 d-none card'; previewArea.innerHTML='<div class="card-body"></div>';
  if(submitArea && submitArea.parentElement){ submitArea.parentElement.appendChild(previewArea); }
  previewBtn.addEventListener('click', ()=>{ const area = document.getElementById('previewAreaEdit'); if(area.classList.contains('d-none')){ area.classList.remove('d-none'); area.querySelector('.card-body').innerHTML = marked.parse(easyMDE ? easyMDE.value() : document.getElementById('body').value); previewBtn.textContent='Hide Preview'; } else { area.classList.add('d-none'); previewBtn.textContent='Preview'; }});
  // autosave status
  const autos = document.createElement('small'); autos.id='autosaveEditStatus'; autos.className='text-muted ms-2'; if(submitArea) submitArea.appendChild(autos);
}

// Ensure selects are loaded before populating the post and then setup UI
loadOptions().then(() => loadPost()).then(()=>setupEditUI()).catch(() => { loadPost().then(()=>setupEditUI()); });

  // Populate selects (site, author)
  async function loadOptions() {
    const [sites, authors] = await Promise.all([
      WriterAPI.apiFetch(WriterAPI.API.SITES).then(r=>r.json()),
      WriterAPI.apiFetch(WriterAPI.API.AUTHORS).then(r=>r.json()),
    ]);
    const siteSel = document.getElementById('siteSelect');
    (sites.results || sites).forEach(s => siteSel.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.name || s.title}</option>`));
    const authorSel = document.getElementById('authorSelect');
      (authors.results || authors).forEach(a => authorSel.insertAdjacentHTML('beforeend', `<option value="${a.id}">${a.name || a.display_name}</option>`));
    }

  // Republish logic (consolidated later)

  // CSRF cookie helper
  function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`);if(v.length===2)return v.pop().split(';').shift();}
  // Minimal helpers to show field errors like in new-post
  function setInvalid(name, msg) {
    const field = document.querySelector(`[name="${name}"]`);
    if (!field) return;
    field.classList.add('is-invalid');
    const fb = field.parentElement.querySelector('.invalid-feedback');
    if (fb && msg) fb.textContent = msg;
  }
  function clearInvalid() {
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
  }

  // Submit PATCH
  const form = document.getElementById('post-edit-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearInvalid();
    const fd = new FormData(form);
    const payload = {
      title: fd.get('title'),
      slug: fd.get('slug'),
      site: Number(fd.get('site')) || null,
      author: Number(fd.get('author')) || null,
      content: easyMDE ? easyMDE.value() : document.getElementById('body').value,
    };
    const resultBox = document.getElementById('result');
    resultBox.innerHTML = '';
    try {
      const res = await WriterAPI.apiFetch(`${WriterAPI.API.POSTS}${postId}/`, {
        method: 'PATCH',
        body: JSON.stringify(payload)
      });
      let data = null;
      try { data = await res.json(); } catch(_) { data = null; }
      if (res.ok) {
        resultBox.innerHTML = '<div class="alert alert-success">Post aggiornato!</div>';
      } else {
        if (res.status === 400 && data) {
          Object.entries(data).forEach(([field, messages]) => {
            setInvalid(field, Array.isArray(messages) ? messages.join(', ') : String(messages));
          });
        }
        let errorMsg = 'Errore salvataggio.';
        if (data) {
          if (data.detail) errorMsg = data.detail;
          else if (typeof data === 'object') errorMsg = Object.values(data).flat().join('<br>');
          else errorMsg = String(data);
        }
        resultBox.innerHTML = `<div class="alert alert-danger">${errorMsg}</div>`;
      }
    } catch (err) {
      resultBox.innerHTML = `<div class="alert alert-danger">Errore di rete: ${err}</div>`;
    }
  });
// Re-publish button
const republishBtn = document.getElementById('republishBtn');
republishBtn.addEventListener('click', async () => {
  // PATCH vuoto per forzare re-export
  const res = await WriterAPI.apiFetch(`${WriterAPI.API.POSTS}${postId}/`, {
    method: 'PATCH',
    body: JSON.stringify({})
  });
  const resultBox = document.getElementById('result');
  if (res.ok) {
    resultBox.innerHTML = '<div class="alert alert-success">Post ripubblicato!</div>';
  } else {
    let errorMsg = 'Errore ripubblicazione.';
    try {
      const errData = await res.json();
      if (errData.detail) {
        errorMsg = errData.detail;
      } else if (typeof errData === 'string') {
        errorMsg = errData;
      } else if (typeof errData === 'object') {
        errorMsg = Object.values(errData).flat().join('<br>');
      }
    } catch {}
    resultBox.innerHTML = `<div class="alert alert-danger">${errorMsg}</div>`;
  }
});
</script>

<!-- Quick Preview (Unified System) JavaScript -->
<script>
(function() {
  let quickPreviewUrl = null;
  let quickPreviewPath = null;
  let permanentPreviewUrl = null;  // Stored preview URL from post data
  
  function showQuickPreviewError(message) {
    const errorDiv = document.getElementById('quick-preview-error');
    errorDiv.textContent = message;
    errorDiv.classList.remove('d-none');
  }
  
  function hideQuickPreviewError() {
    document.getElementById('quick-preview-error').classList.add('d-none');
  }
  
  function buildPermanentPreviewUrl() {
    // Build permanent preview URL based on post ID and site
    if (!currentSiteId || !postId) return null;
    
    // Get site info from sites array
    const site = sites.find(s => s.id === currentSiteId);
    if (!site || !site.repo_owner || !site.repo_name) return null;
    
    const owner = site.repo_owner.toLowerCase();
    const repo = site.repo_name;
    return `https://${owner}.github.io/${repo}/preview/${postId}/`;
  }
  
  function updateQuickPreviewUI(hasPreview = false) {
    const statusDiv = document.getElementById('quick-preview-status');
    const urlArea = document.getElementById('quick-preview-url-area');
    const createBtn = document.getElementById('create-quick-preview-btn');
    const deleteBtn = document.getElementById('delete-quick-preview-btn');
    const urlInput = document.getElementById('quick-preview-url-input');
    const visitBtn = document.getElementById('visit-preview-btn');
    
    // Always show permanent URL if we can build it
    const previewUrl = permanentPreviewUrl || buildPermanentPreviewUrl();
    
    if (previewUrl) {
      urlInput.value = previewUrl;
      visitBtn.href = previewUrl;
      urlArea.classList.remove('d-none');
      
      if (hasPreview) {
        // Preview exists
        statusDiv.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Preview attiva</span>';
        createBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Aggiorna Preview';
        deleteBtn.classList.remove('d-none');
      } else {
        // No preview yet, but show where it will be
        statusDiv.innerHTML = '<span class="badge bg-secondary"><i class="bi bi-info-circle"></i> URL permanente</span>';
        createBtn.innerHTML = '<i class="bi bi-play-circle"></i> Crea Preview';
        deleteBtn.classList.add('d-none');
      }
    } else {
      // Cannot determine preview URL
      statusDiv.innerHTML = '<span class="text-muted small">Configura repo per abilitare preview</span>';
      urlArea.classList.add('d-none');
      createBtn.disabled = true;
      deleteBtn.classList.add('d-none');
    }
  }
  
  async function createQuickPreview() {
    try {
      hideQuickPreviewError();
      
      const btn = document.getElementById('create-quick-preview-btn');
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creazione...';
      
      const res = await WriterAPI.apiFetch(`/api/posts/${postId}/preview/`, {
        method: 'POST'
      });
      
      const data = await res.json();
      
      if (!res.ok) {
        throw new Error(data.detail || 'Errore creazione preview');
      }
      
      // Store permanent URL from response
      if (data.preview_url) {
        permanentPreviewUrl = data.preview_url;
      }
      
      // Success - update UI
      updateQuickPreviewUI(true);
      
      // Show success message
      const resultBox = document.getElementById('result');
      resultBox.innerHTML = `
        <div class="alert alert-success alert-dismissible fade show">
          <i class="bi bi-check-circle"></i> Preview creata con successo!
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        resultBox.innerHTML = '';
      }, 5000);
      
    } catch (e) {
      showQuickPreviewError(`Errore: ${e.message}`);
    } finally {
      const btn = document.getElementById('create-quick-preview-btn');
      btn.disabled = false;
      updateQuickPreviewUI(!!permanentPreviewUrl);
    }
  }
  
  async function deleteQuickPreview() {
    if (!confirm('Vuoi eliminare questa preview?')) {
      return;
    }
    
    try {
      hideQuickPreviewError();
      
      const btn = document.getElementById('delete-quick-preview-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminazione...';
      
      const res = await WriterAPI.apiFetch(`/api/posts/${postId}/preview/`, {
        method: 'DELETE'
      });
      
      const data = await res.json();
      
      if (!res.ok) {
        throw new Error(data.detail || 'Errore eliminazione preview');
      }
      
      // Success - update UI
      updateQuickPreviewUI(false);
      
      // Show success message
      const resultBox = document.getElementById('result');
      resultBox.innerHTML = `
        <div class="alert alert-info alert-dismissible fade show">
          <i class="bi bi-info-circle"></i> Preview eliminata (status: ${data.status})
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      setTimeout(() => {
        resultBox.innerHTML = '';
      }, 5000);
      
    } catch (e) {
      showQuickPreviewError(`Errore: ${e.message}`);
    } finally {
      const btn = document.getElementById('delete-quick-preview-btn');
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-trash"></i> Elimina Preview';
    }
  }
  
  function copyPreviewUrl() {
    const input = document.getElementById('quick-preview-url-input');
    input.select();
    input.setSelectionRange(0, 99999); // For mobile
    
    navigator.clipboard.writeText(input.value).then(() => {
      const btn = document.getElementById('copy-preview-url-btn');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="bi bi-check"></i>';
      setTimeout(() => {
        btn.innerHTML = originalHTML;
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy:', err);
    });
  }
  
  function updateSiteSlugDisplay() {
    // Get site slug from the selected site
    const siteSelect = document.getElementById('siteSelect');
    const selectedOption = siteSelect?.options[siteSelect.selectedIndex];
    const siteName = selectedOption?.text || '...';
    
    // Try to extract slug from site name (lowercase, no special chars)
    const siteSlug = siteName.toLowerCase().replace(/[^a-z0-9]+/g, '');
    document.getElementById('site-slug-display').textContent = siteSlug || '...';
  }
  
  // Event listeners
  document.getElementById('create-quick-preview-btn').addEventListener('click', createQuickPreview);
  document.getElementById('delete-quick-preview-btn').addEventListener('click', deleteQuickPreview);
  document.getElementById('copy-preview-url-btn').addEventListener('click', copyPreviewUrl);
  
  // Update site slug display when site changes
  document.getElementById('siteSelect')?.addEventListener('change', updateSiteSlugDisplay);
  
  // Initialize: load post data and check for existing preview
  async function initializePreview() {
    try {
      // Load post data to get preview_url if exists
      const res = await WriterAPI.apiFetch(`/api/blog/posts/${postId}/`);
      if (res.ok) {
        const postData = await res.json();
        if (postData.preview_url) {
          permanentPreviewUrl = postData.preview_url;
          updateQuickPreviewUI(true);  // Has preview
        } else {
          updateQuickPreviewUI(false);  // No preview yet, show permanent URL
        }
      } else {
        updateQuickPreviewUI(false);
      }
    } catch (e) {
      console.warn('Failed to load preview status:', e);
      updateQuickPreviewUI(false);
    }
    updateSiteSlugDisplay();
  }
  
  // Run initialization after page load
  setTimeout(initializePreview, 1000);
})();
</script>

{% endblock %}

<!-- Mobile bottom action bar for editor -->
<div id="mobileEditorBarEdit" class="d-md-none" style="position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid rgba(0,0,0,0.06);padding:8px 12px;z-index:1060;display:flex;gap:.5rem;justify-content:space-between;align-items:center;">
  <button id="mobileSaveEdit" class="btn btn-primary" style="flex:1">Save</button>
  <button id="mobilePreviewEdit" class="btn btn-outline-secondary" style="flex:1">Preview</button>
  <button id="mobileDraftEdit" class="btn btn-outline-secondary" style="flex:1">Draft</button>
</div>
<script>
  document.getElementById('mobileSaveEdit')?.addEventListener('click', ()=> document.querySelector('#post-edit-form button[type="submit"]')?.click());
  document.getElementById('mobilePreviewEdit')?.addEventListener('click', ()=> { document.querySelector('#post-edit-form .btn-outline-secondary')?.click(); });
  document.getElementById('mobileDraftEdit')?.addEventListener('click', ()=> document.getElementById('draftBtn')?.click());
</script>
