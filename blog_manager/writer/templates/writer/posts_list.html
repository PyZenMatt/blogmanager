{% load static %}
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Posts · Writer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand" href="#">Writer</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'writer:post_list' %}">Posts</a>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'writer:post_new' %}">+ Nuovo</a>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'writer:taxonomy' %}">Taxonomy</a>
      <form method="post" action="{% url 'writer:logout' %}" class="d-inline">
        {% csrf_token %}
        <button class="btn btn-outline-secondary btn-sm" type="submit">Logout</button>
      </form>
    </div>
  </div>
</nav>

<div class="container py-4">
  <h1 class="h4 mb-3">Lista Post</h1>

  <form id="filters" class="row g-2 align-items-end mb-3">
    <div class="col-md-3">
      <label class="form-label">Site</label>
      <select id="fSite" class="form-select">
        <option value="">Tutti</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Status</label>
      <select id="fStatus" class="form-select">
        <option value="">Tutti</option>
        <option value="draft">Draft</option>
        <option value="review">Review</option>
        <option value="published">Published</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Search</label>
      <input id="fSearch" class="form-control" placeholder="titolo, slug, testo…">
    </div>
    <div class="col-md-2 d-grid">
      <button class="btn btn-primary" type="submit">Applica</button>
    </div>
  </form>

  <div id="result"></div>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:80px;">ID</th>
            <th style="width:220px;">Site</th>
            <th>Titolo</th>
            <th style="width:140px;">Status</th>
            <th style="width:170px;">Published</th>
            <th style="width:170px;">Updated</th>
            <th style="width:230px;">Actions</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="6" class="text-center p-4">Caricamento…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <nav class="mt-3" aria-label="pagination">
    <ul class="pagination" id="pager"></ul>
  </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // CSRF cookie
  function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`);if(v.length===2)return v.pop().split(';').shift();}
  const csrftoken = getCookie('csrftoken');

  const state = { next:null, prev:null, page:1 };

  const sitesById = {};
  async function loadSites(){
    const res = await fetch('/api/sites/');
    const data = await res.json();
    const sel = document.getElementById('fSite');
    (data.results || []).forEach(s=>{
      sitesById[s.id]=s;
      sel.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.name || s.title}</option>`);
    });
  }

  function badgeStatus(s){
    const m = { draft:'secondary', review:'warning', published:'success' };
    return `<span class="badge text-bg-${m[s]||'secondary'}">${s||'-'}</span>`;
  }

  function siteCell(post){
    const s = sitesById[post.site];
    if(!s) return '-';
    const base = s.base_url || s.url || '#';
    return `
      <div class="d-flex flex-column">
        <div><span class="badge text-bg-info">${s.name || s.title}</span></div>
        <a href="${base}" target="_blank" class="small text-decoration-none">${base}</a>
      </div>`;
  }

  function actionsCell(post){
    const s = sitesById[post.site] || {};
    const live = post.canonical_url || '';
    // Link al file nel repo (se abbiamo repo metadata + repo_path)
    let repoLink = '';
    if (post.repo_path && s.repo_owner && s.repo_name && (s.default_branch || 'main')) {
      const branch = s.default_branch || 'main';
      const gh = `https://github.com/${s.repo_owner}/${s.repo_name}/blob/${branch}/${post.repo_path}`;
      repoLink = `<a class="btn btn-sm btn-outline-secondary" href="${gh}" target="_blank">Repo</a>`;
    }
    return `
      <div class="btn-group" role="group">
        <a class="btn btn-sm btn-primary" href="/writer/edit/${post.id}/">Edit</a>
        ${ live ? `<a class="btn btn-sm btn-outline-secondary" href="${live}" target="_blank">Live</a>` : ``}
        ${ repoLink || ``}
      </div>`;
  }

  function formatDate(s){
    if(!s) return '-';
    const d = new Date(s);
    return d.toLocaleString(undefined, {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
  }

  function render(data){
    const rows = document.getElementById('rows');
    if(!data.results || data.results.length===0){
      rows.innerHTML = `<tr><td colspan="6" class="text-center p-4">Nessun risultato</td></tr>`;
      document.getElementById('pager').innerHTML='';
      return;
    }
    rows.innerHTML = data.results.map(p=>`
      <tr>
        <td>#${p.id}</td>
        <td>${siteCell(p)}</td>
        <td>
          <div class="fw-semibold">${p.title||'-'}</div>
          <div class="text-muted small">${p.slug||''}</div>
        </td>
        <td>${badgeStatus(p.status)}</td>
        <td>${formatDate(p.published_at)}</td>
        <td>${formatDate(p.updated_at)}</td>
        <td>${actionsCell(p)}</td>
      </tr>
    `).join('');

    // Paginazione (DRF: next/previous URL)
    const pager = document.getElementById('pager');
    state.next = data.next; state.prev = data.previous;
    const prevDisabled = state.prev ? '' : ' disabled';
    const nextDisabled = state.next ? '' : ' disabled';
    pager.innerHTML = `
      <li class="page-item${prevDisabled}"><a class="page-link" href="#" data-nav="prev">«</a></li>
      <li class="page-item disabled"><span class="page-link">Risultati: ${data.count}</span></li>
      <li class="page-item${nextDisabled}"><a class="page-link" href="#" data-nav="next">»</a></li>
    `;
    pager.querySelectorAll('a[data-nav]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const url = e.target.dataset.nav==='next' ? state.next : state.prev;
        if(url) loadPosts(url);
      })
    });
  }

  function buildPostsUrl(baseUrl=null){
    const site = document.getElementById('fSite').value;
    const status = document.getElementById('fStatus').value;
    const search = document.getElementById('fSearch').value.trim();
    const params = new URLSearchParams();
    if(site) params.set('site', site);
    if(status) params.set('status', status);
    if(search) params.set('search', search);
    params.set('ordering', '-published_at');
    return (baseUrl || '/api/posts/') + (baseUrl && baseUrl.includes('?') ? '&' : '?') + params.toString();
  }

  async function loadPosts(url=null){
    const resBox = document.getElementById('result');
    resBox.innerHTML = '';
    const endpoint = url || buildPostsUrl();
    try {
      const res = await fetch(endpoint, { credentials: 'same-origin' });
      const data = await res.json();
      if(!res.ok) throw new Error(JSON.stringify(data));
      render(data);
    } catch (e) {
      resBox.innerHTML = `<div class="alert alert-danger">Errore nel caricamento: ${e}</div>`;
    }
  }

  document.getElementById('filters').addEventListener('submit', (e)=>{
    e.preventDefault();
    loadPosts(buildPostsUrl('/api/posts/'));
  });

  (async function init(){
    await loadSites();
    await loadPosts();
  })();
</script>
</body>
</html>
