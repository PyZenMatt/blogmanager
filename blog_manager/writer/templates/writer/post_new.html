{% load static %}
<!doctype html>
<html lang="it">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nuovo Post</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- EasyMDE (Markdown WYSIWYG) -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">

			<style>
				/* Responsive editor: full-width on small screens, constrained on large screens */
				.editor-fixed { width: 100%; max-width: 1000px; margin: 0 auto; }
				.editor-fixed textarea, .editor-fixed .EasyMDEContainer, .editor-fixed .CodeMirror, .editor-fixed .editor-toolbar {
					width: 100% !important; max-width: 100% !important; box-sizing: border-box;
				}
				/* CodeMirror (EasyMDE) specifics: set fixed height and allow vertical scrolling */
				.editor-fixed .CodeMirror { height: 500px !important; max-height: 500px !important; }
				.editor-fixed .CodeMirror-scroll { overflow: auto !important; }
				/* Ensure textarea fallback can only resize vertically */
				textarea#body { resize: vertical; }

				@media (max-width: 576px) {
					.editor-fixed { padding: 0 12px; }
					.d-flex.align-items-center.gap-2.mt-4 { flex-direction: column !important; }
					.d-flex.align-items-center.gap-2.mt-4 .btn { width: 100%; }
					#previewArea { margin-left: 0 !important; margin-right: 0 !important; }
				}
			</style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom">
	<div class="container">
		<a class="navbar-brand" href="#">Writer</a>
		<div class="ms-auto d-flex gap-2">
			<a class="btn btn-outline-secondary btn-sm" href="{% url 'writer:post_list' %}">Lista post</a>
			<form method="post" action="{% url 'writer:logout' %}" class="d-inline">
				{% csrf_token %}
				<button class="btn btn-outline-secondary btn-sm" type="submit">Logout</button>
			</form>
		</div>
	</div>
</nav>

<div class="container py-4">
	<div id="result"></div>

	<div class="card shadow-sm">
		<div class="card-body">
			<h1 class="h4 mb-4">Crea nuovo post</h1>
			<form id="post-form" class="needs-validation" novalidate>
				{% csrf_token %}
				<div class="row g-3">
					<div class="col-md-8">
						<label class="form-label">Title</label>
						<input name="title" id="title" class="form-control" required>
						<div class="invalid-feedback">Titolo obbligatorio.</div>
					</div>
					<div class="col-md-4">
						<label class="form-label">Slug</label>
						<input name="slug" id="slug" class="form-control" placeholder="auto dal titolo">
					</div>

					<div class="col-md-4">
						<label class="form-label">Site</label>
						<select name="site" id="siteSelect" class="form-select" required></select>
						<div class="invalid-feedback">Seleziona un sito.</div>
					</div>

					<div class="col-md-4">
						<label class="form-label">Author</label>
						<select name="author" id="authorSelect" class="form-select" required></select>
						<div class="invalid-feedback">Seleziona un autore.</div>
					</div>

					<div class="col-md-4">
						<label class="form-label">Status</label>
						<select name="status" class="form-select">
							<option value="draft">draft</option>
							<option value="published">published</option>
						</select>
					</div>

					<!-- Categories are derived from post front-matter and managed by the sync/export pipeline.
						 The writer UI no longer allows editing categories directly. Display-only area could be
						 added if needed, but the selection control has been removed to make categories read-only. -->

					<div class="col-md-6">
						<label class="form-label">Published at</label>
						<input type="datetime-local" name="published_at" class="form-control">
					</div>

					<div class="col-md-6">
						<label class="form-label">Cover image URL (Cloudinary)</label>
						<input name="cover_image_url" class="form-control" placeholder="https://res.cloudinary.com/...">
					</div>

					<!-- SEO fields removed: meta_title/meta_description/meta_keywords -->
					<div class="col-md-6">
						<label class="form-label">Canonical URL</label>
						<input name="canonical_url" id="canonical_url" class="form-control" placeholder="Auto-filled if left blank">
					</div>
					<!-- OG and noindex fields removed -->

					<div class="col-12">
						<label class="form-label">Body (Markdown)</label>
						<div class="editor-fixed">
							<textarea name="body" id="body" rows="12" class="form-control" required></textarea>
						</div>
						<div class="invalid-feedback">Inserisci il contenuto.</div>
					</div>
				</div>

				<div class="d-flex align-items-center gap-2 mt-4">
					<button class="btn btn-primary" type="submit" id="submitBtn">
						<span class="spinner-border spinner-border-sm d-none" id="btnSpinner" role="status" aria-hidden="true"></span>
						<span id="btnText">Crea post</span>
					</button>
					<button class="btn btn-outline-secondary" type="reset">Reset</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
	// CSRF helper (cookie)
	function getCookie(name) {
		const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`);
		if (parts.length === 2) return parts.pop().split(';').shift();
	}
		// Use shared helpers (guard if WriterAPI not defined)
		const csrftoken = (window.WriterAPI && WriterAPI.CSRF_TOKEN) ? WriterAPI.CSRF_TOKEN : getCookie('csrftoken');

		// Unified fetch wrapper: prefer WriterAPI.apiFetch if available, otherwise fallback to fetch
		async function doApiFetch(path, opts = {}){
			if (window.WriterAPI && typeof WriterAPI.apiFetch === 'function'){
				return WriterAPI.apiFetch(path, opts);
			}
			// Ensure credentials and JSON content-type by default
			const init = Object.assign({ credentials: 'same-origin' }, opts);
			init.headers = init.headers || {};
			if (!init.headers['Content-Type'] && !(init.body instanceof FormData)) init.headers['Content-Type'] = 'application/json';
			if (['POST','PUT','PATCH','DELETE'].includes((init.method||'GET').toUpperCase())){
				init.headers['X-CSRFToken'] = csrftoken;
			}
			return fetch(path, init);
		}

	// EasyMDE init
	const easyMDE = new EasyMDE({
		element: document.getElementById('body'),
		spellChecker: false,
		autofocus: true,
		status: false,
		autosave: { enabled: false },
		placeholder: "Scrivi in Markdown…",
	});

	// Auto-slug dal titolo
	const titleInput = document.getElementById('title');
	const slugInput  = document.getElementById('slug');
	titleInput.addEventListener('input', () => {
		if (slugInput.value.trim() !== "") return;
		slugInput.value = titleInput.value
			.toLowerCase()
			.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
			.replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
	});

	// Populate selects
	async function loadOptions() {
		const elResult = document.getElementById('result');
		elResult.innerHTML = '<div class="alert alert-info">Carico dati…</div>';
		try {
				let sitesResp, authorsResp;
				if (window.WriterAPI && typeof WriterAPI.apiFetch === 'function'){
					sitesResp = await WriterAPI.apiFetch(WriterAPI.API.SITES);
					authorsResp = await WriterAPI.apiFetch(WriterAPI.API.AUTHORS);
				} else {
					// fallback to fetch with credentials
					sitesResp = await fetch('/api/sites/', { credentials: 'same-origin' });
					authorsResp = await fetch('/api/blog/authors/', { credentials: 'same-origin' });
				}
				const sites = await sitesResp.json().catch(()=>[]);
				const authors = await authorsResp.json().catch(()=>[]);

				const siteSel = document.getElementById('siteSelect');
				(sites.results || sites).forEach(s => siteSel.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.name || s.title}</option>`));

				const authorSel = document.getElementById('authorSelect');
				(authors.results || authors).forEach(a => authorSel.insertAdjacentHTML('beforeend', `<option value="${a.id}">${a.name || a.display_name}</option>`));

				elResult.innerHTML = '';
			} catch (e) {
				elResult.innerHTML = `<div class="alert alert-danger">Errore nel caricamento opzioni: ${e}</div>`;
			}
		// Only try to load categories if the categories select exists (we removed the edit control in the UI)
		if (document.getElementById('catSelect')) {
			await loadCategoriesForSite();
			const siteSelForCats = document.getElementById('siteSelect');
			if (siteSelForCats) siteSelForCats.addEventListener('change', loadCategoriesForSite);
		}
	}

	async function loadCategoriesForSite() {
		const catSel = document.getElementById('catSelect');
		if (!catSel) return; // nothing to do when the select was removed
		const siteEl = document.getElementById('siteSelect');
		const siteId = siteEl ? siteEl.value : null;
		catSel.innerHTML = '';
		if (!siteId) return;
		const catsPath = (window.WriterAPI && WriterAPI.API && WriterAPI.API.CATEGORIES) ? `${WriterAPI.API.CATEGORIES}?site=${siteId}` : `/api/blog/categories/?site=${siteId}`;
		const res = await doApiFetch(catsPath);
		const cats = await res.json().catch(()=>[]);
		(cats.results || cats).forEach(c => catSel.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.name || c.title}</option>`));
	}
	loadOptions();

	// --- Autosave (localStorage) and Preview ---
	const AUTOSAVE_KEY = 'writer:draft:new';

	function loadDraft(){
		const raw = localStorage.getItem(AUTOSAVE_KEY);
		if(!raw) return;
		try{
			const d = JSON.parse(raw);
			if(confirm('Trovata bozza salvata localmente. Ripristinare?')){
				document.getElementById('title').value = d.title || '';
				document.getElementById('slug').value = d.slug || '';
				document.getElementById('siteSelect').value = d.site || '';
				document.getElementById('authorSelect').value = d.author || '';
				document.getElementById('cover_image_url').value = d.cover_image_url || '';
				// categories are read-only and not restored from the draft UI
				easyMDE.value(d.body || '');
			}
		} catch(e){ console.warn('Failed to parse draft', e); }
	}

	function saveDraft(){
		try{
			const payload = {
				title: document.getElementById('title').value,
				slug: document.getElementById('slug').value,
				site: document.getElementById('siteSelect').value,
				author: document.getElementById('authorSelect').value,
				// categories are managed from front-matter/exporter; do not send from the writer UI
				cover_image_url: document.querySelector('[name="cover_image_url"]').value,
				body: easyMDE.value(),
				timestamp: new Date().toISOString()
			};
			localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(payload));
			document.getElementById('autosaveStatus').textContent = 'Autosaved at ' + new Date().toLocaleTimeString();
		} catch(e){ console.warn('Autosave failed', e); }
	}

	function setupAutosave(){
		saveDraft();
		setInterval(saveDraft, 10000);
	}

	// Preview
	const previewBtn = document.createElement('button');
	previewBtn.type = 'button'; previewBtn.id = 'previewBtn'; previewBtn.className = 'btn btn-outline-secondary'; previewBtn.textContent = 'Preview';
	const submitGroup = document.querySelector('.d-flex.align-items-center');
	if(submitGroup){ submitGroup.insertBefore(previewBtn, submitGroup.children[1] || null); }

	// Create a full-width preview area and insert it directly under the Body (Markdown) field
	const previewArea = document.createElement('div');
	previewArea.id = 'previewArea';
	previewArea.className = 'mt-3 d-none card w-100';
	previewArea.innerHTML = '<div class="card-body"></div>';
	// Find the column that wraps the textarea and insert after it
	(function(){
		const bodyEl = document.getElementById('body');
		if(!bodyEl) return;
		let col = bodyEl.closest('.col-12') || bodyEl.parentElement;
		if(col && col.parentElement){
			if(col.nextSibling){
				col.parentElement.insertBefore(previewArea, col.nextSibling);
			} else {
				col.parentElement.appendChild(previewArea);
			}
		} else if(submitGroup && submitGroup.parentElement){
			submitGroup.parentElement.appendChild(previewArea);
		}
	})();

	previewBtn.addEventListener('click', ()=>{
		const area = document.getElementById('previewArea');
		if(!area) return;
		if(area.classList.contains('d-none')){
			area.classList.remove('d-none');
			area.querySelector('.card-body').innerHTML = marked.parse(easyMDE.value());
			previewBtn.textContent = 'Hide Preview';
		} else { area.classList.add('d-none'); previewBtn.textContent = 'Preview'; }
	});

	// Insert autosave status element
	const autos = document.getElementById('btnText')?.parentElement || document.querySelector('.d-flex.align-items-center');
	if(autos){
		const s = document.createElement('small'); s.id = 'autosaveStatus'; s.className='text-muted ms-2'; autos.appendChild(s);
	}

	loadDraft();
	setupAutosave();

	// Helpers UI bottone submit
	const btn = document.getElementById('submitBtn');
	const btnSpinner = document.getElementById('btnSpinner');
	const btnText = document.getElementById('btnText');
	function setSubmitting(on) {
		btn.disabled = on;
		btnSpinner.classList.toggle('d-none', !on);
		btnText.textContent = on ? 'Invio…' : 'Crea post';
	}

	// Validazione lato client (Bootstrap)
	function setInvalid(name, msg) {
		const field = document.querySelector(`[name="${name}"]`);
		if (!field) return;
		field.classList.add('is-invalid');
		const feedback = field.parentElement.querySelector('.invalid-feedback');
		if (feedback && msg) feedback.textContent = msg;
	}
	function clearInvalid() {
		document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
	}

	// Submit
	document.getElementById('post-form').addEventListener('submit', async (e) => {
		e.preventDefault();
		clearInvalid();
		setSubmitting(true);

	const fd = new FormData(e.target);
	// categories control removed from the UI; do not attempt to access it
	const payload = {
			title: fd.get('title'),
			slug: fd.get('slug') || null,
			site: Number(fd.get('site')),
			// categories are managed from front-matter/exporter; do not send from the writer UI
			author: Number(fd.get('author')),
			status: fd.get('status') || 'draft',
			published_at: fd.get('published_at') ? new Date(fd.get('published_at')).toISOString() : null,
			content: easyMDE.value(), // Markdown dal WYSIWYG
			is_published: (fd.get('status') === 'published'),
			cover_image_url: fd.get('cover_image_url') || null,
		};

		const resBox = document.getElementById('result');

		try {
			const res = await doApiFetch((window.WriterAPI && WriterAPI.API && WriterAPI.API.POSTS) ? WriterAPI.API.POSTS : '/api/blog/posts/', {
				method: 'POST',
				body: JSON.stringify(payload)
			});
			const data = await res.json();

			if (!res.ok) {
				// Mostra messaggi 400 field->error
				if (res.status === 400 && data) {
					Object.entries(data).forEach(([field, messages]) => {
						setInvalid(field, Array.isArray(messages) ? messages.join(', ') : String(messages));
					});
				}
				resBox.innerHTML = `<div class="alert alert-danger">❌ Errore creazione: <pre class="mb-0">${JSON.stringify(data, null, 2)}</pre></div>`;
			} else {
				resBox.innerHTML = `<div class="alert alert-success">✅ Post creato: ID <b>${data.id}</b></div>`;
				e.target.reset();
				easyMDE.value('');
			}
		} catch (err) {
			resBox.innerHTML = `<div class="alert alert-danger">❌ Network error: ${err}</div>`;
		} finally {
			setSubmitting(false);
		}
	});
</script>
</body>

<!-- Mobile bottom action bar -->
<div id="mobileEditorBar" class="d-md-none" style="position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid rgba(0,0,0,0.06);padding:8px 12px;z-index:1060;display:flex;gap:.5rem;justify-content:space-between;align-items:center;">
	<button id="mobileSave" class="btn btn-primary" style="flex:1">Save</button>
	<button id="mobilePreview" class="btn btn-outline-secondary" style="flex:1">Preview</button>
	<button id="mobileDraft" class="btn btn-outline-secondary" style="flex:1">Draft</button>
</div>
<script>
	// Wire mobile bottom bar to existing actions
	document.getElementById('mobileSave')?.addEventListener('click', ()=> document.getElementById('submitBtn')?.click());
	document.getElementById('mobilePreview')?.addEventListener('click', ()=> document.getElementById('previewBtn')?.click());
	document.getElementById('mobileDraft')?.addEventListener('click', ()=> { document.querySelector('[name="status"]').value='draft'; document.getElementById('submitBtn')?.click(); });
</script>
</body>
</html>
