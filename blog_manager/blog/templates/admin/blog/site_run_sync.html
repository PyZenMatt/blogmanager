{% extends "admin/base_site.html" %}
{% block content %}
<h1>Run sync for site {{ site.slug }}</h1>
<form method="post">{% csrf_token %}
  <p>
    <label><input type="radio" name="mode" value="dry" checked> Dry-run (no DB changes)</label><br>
    <label><input type="radio" name="mode" value="apply"> Apply (create/update posts)</label>
  </p>
  <p><button type="submit" class="default">Run</button></p>
</form>
{% if output %}
<h2>Run Status</h2>
<div id="run-status">{{ output }}</div>
{% endif %}

<h2>Live Log</h2>
<pre id="live-log" style="height: 480px; overflow: auto; background: #111; color: #ddd; padding: 8px; white-space: pre-wrap; font-family: monospace; border-radius:4px;">{% if log_content %}{{ log_content }}{% else %}No log yet.{% endif %}</pre>

<script>
// Poll the tail endpoint every 2s
function pollLog(){
  const pre = document.getElementById('live-log');
  const tailUrl = window.location.pathname.replace(/\/run_sync\/$/, '/run_sync/tail/') ;
  fetch(tailUrl)
    .then(r=>r.json())
    .then(j=>{
      if(j.status==='ok'){
        pre.textContent = j.log;
        pre.scrollTop = pre.scrollHeight;
      }
    }).catch(()=>{});
}
setInterval(pollLog, 2000);
// initial fetch
pollLog();
</script>
{# Recent ExportAudits removed from this view (logs shown live) #}
{% endblock %}
